# Home Assistant Integration Rules

## MANDATORY: Home Assistant Documentation Reference

**ALWAYS** reference Home Assistant documentation when implementing integration features:

### Primary Documentation Sources
- **Development Index:** https://developers.home-assistant.io/docs/development_index
- **WebSocket API:** https://developers.home-assistant.io/docs/api/websocket/
- **REST API:** https://developers.home-assistant.io/docs/api/rest/
- **External APIs:** https://developers.home-assistant.io/docs/api/

### Implementation Standards

#### WebSocket Integration
- **ALWAYS** follow the official WebSocket API authentication flow
- **ALWAYS** implement proper message correlation with `id` fields
- **ALWAYS** handle `auth_required`, `auth_ok`, and `auth_invalid` messages
- **ALWAYS** implement ping/pong heartbeat mechanism
- **ALWAYS** use `subscribe_events` for real-time event monitoring
- **ALWAYS** handle `state_changed` events for device state updates
- **ALWAYS** implement proper error handling with Home Assistant error codes

#### REST API Integration
- **ALWAYS** use long-lived access tokens for authentication
- **ALWAYS** follow Home Assistant REST API conventions
- **ALWAYS** implement proper rate limiting and error handling
- **ALWAYS** use Bearer token authentication in Authorization header

#### Event Processing
- **ALWAYS** validate event data against Home Assistant schemas
- **ALWAYS** handle all required event fields (entity_id, state, attributes, timestamps)
- **ALWAYS** implement proper state change detection and processing
- **ALWAYS** store events with proper timezone handling

#### Security and Best Practices
- **ALWAYS** encrypt access tokens in configuration
- **ALWAYS** implement secure credential rotation
- **ALWAYS** validate Home Assistant URLs and connection parameters
- **ALWAYS** implement proper connection health monitoring
- **ALWAYS** follow Home Assistant security guidelines

### Documentation Requirements
- **ALWAYS** cite Home Assistant documentation in code comments
- **ALWAYS** reference specific API endpoints and message formats
- **ALWAYS** document any deviations from official Home Assistant patterns
- **ALWAYS** include Home Assistant version compatibility notes

### Automation API Integration
- **ALWAYS** use Home Assistant's official automation API endpoints
- **ALWAYS** implement proper authentication for automation operations
- **ALWAYS** validate automation syntax before deployment
- **ALWAYS** implement backup snapshots before modifying automations
- **ALWAYS** use proper error handling for automation API failures
- **ALWAYS** implement rollback mechanisms for failed automation changes

### Testing Requirements
- **ALWAYS** test against actual Home Assistant instances
- **ALWAYS** validate WebSocket connection lifecycle
- **ALWAYS** test event subscription and processing
- **ALWAYS** verify authentication and error handling
- **ALWAYS** test reconnection scenarios and heartbeat mechanisms
- **ALWAYS** test automation API integration and validation
- **ALWAYS** verify automation backup and rollback mechanisms

### Error Handling
- **ALWAYS** handle Home Assistant specific error codes
- **ALWAYS** implement proper logging for debugging
- **ALWAYS** provide meaningful error messages
- **ALWAYS** implement graceful degradation on connection failures
- **ALWAYS** handle automation API specific error responses
- **ALWAYS** implement proper error recovery for automation operations

## Reference Links
- Home Assistant Developers: https://developers.home-assistant.io/
- WebSocket API: https://developers.home-assistant.io/docs/api/websocket/
- REST API: https://developers.home-assistant.io/docs/api/rest/
- External APIs: https://developers.home-assistant.io/docs/api/
- Development Index: https://developers.home-assistant.io/docs/development_index
- Automation API: https://developers.home-assistant.io/docs/api/rest/
description:
globs:
alwaysApply: false
---
